name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.1"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2022_64"
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat"
          cache: true
          setup-python: false

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        run: choco install ninja -y
        shell: pwsh

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Setup sccache
        run: |
          $version = "v0.8.1"
          $url = "https://github.com/mozilla/sccache/releases/download/$version/sccache-$version-x86_64-pc-windows-msvc.zip"
          Invoke-WebRequest -Uri $url -OutFile sccache.zip
          Expand-Archive sccache.zip -DestinationPath sccache
          echo "$PWD\sccache\sccache-$version-x86_64-pc-windows-msvc" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Build
        env:
          SCCACHE_DIR: ~/.cache/sccache
          SCCACHE_CACHE_SIZE: "2G"
        shell: pwsh
        run: |
          sccache --start-server
          if (-Not (Test-Path build)) {
            New-Item -ItemType Directory -Path build
          }
          cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          cmake --build .
          sccache --show-stats
          sccache --stop-server

      - name: Package App
        run: |
          mkdir Bloom-Windows
          cp build/src/Bloom.exe Bloom-Windows/
          windeployqt Bloom-Windows/Bloom.exe --qmldir src/ui --release --no-translations
          
          # Debug: List all files to see where BloomUI is
          Get-ChildItem -Path Bloom-Windows -Recurse | Select-Object FullName
          
          # Robust cleanup of redundant BloomUI module
          $redundantModule = Get-ChildItem -Path Bloom-Windows -Filter "BloomUI" -Recurse -Directory
          if ($redundantModule) {
            Write-Host "Removing redundant BloomUI module found at: $($redundantModule.FullName)"
            Remove-Item -Recurse -Force $redundantModule.FullName
          } else {
            Write-Host "WARNING: BloomUI module not found in deployment output."
          }

      - name: Install NSIS
        run: |
          choco install nsis -y
        shell: pwsh

      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        shell: pwsh

      - name: Create ZIP Archive and Hash
        id: archive
        run: |
          Compress-Archive -Path Bloom-Windows/* -DestinationPath Bloom-Windows.zip -Force
          $zipHash = (Get-FileHash Bloom-Windows.zip -Algorithm SHA256).Hash
          echo "zip_hash=$zipHash" >> $env:GITHUB_OUTPUT
          echo "ZIP Hash: $zipHash"

          if (Test-Path "Bloom-Setup-0.1.0.exe") {
            $installerHash = (Get-FileHash Bloom-Setup-0.1.0.exe -Algorithm SHA256).Hash
            echo "installer_hash=$installerHash" >> $env:GITHUB_OUTPUT
            echo "Installer Hash: $installerHash"
          }
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: dev-latest
          name: Development Build
          body: |
            Latest development build from main branch.

            ## Portable ZIP
            SHA256: `${{ steps.archive.outputs.zip_hash }}`

            ## Installer
            SHA256: `${{ steps.archive.outputs.installer_hash }}`
          prerelease: true
          files: |
            Bloom-Windows.zip
            Bloom-Setup-0.1.0.exe
          fail_on_unmatched_files: true

      - name: Trigger Scoop Bucket Update
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $version = (Get-Date).ToString("yyyy.MM.dd.HHmm")
          $payload = @{
            event_type = "update-manifest"
            client_payload = @{
              hash = "${{ steps.archive.outputs.zip_hash }}"
              url = "https://github.com/crowquillx/Bloom/releases/download/dev-latest/Bloom-Windows.zip"
              version = $version
            }
          } | ConvertTo-Json -Compress
          
          curl.exe -X POST `
            -H "Accept: application/vnd.github+json" `
            -H "Authorization: Bearer ${{ secrets.SCOOP_REPO_TOKEN }}" `
            https://api.github.com/repos/crowquillx/scoop-bloom/dispatches `
            -d $payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Windows-Portable
          path: Bloom-Windows/

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('Bloom-Setup-0.1.0.exe') != ''
        with:
          name: Bloom-Windows-Installer
          path: Bloom-Setup-0.1.0.exe
