name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.clang-tidy'
      - '.clangd'
  pull_request:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.clang-tidy'
      - '.clangd'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.0"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2022_64"
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat"
          cache: true
          setup-python: false

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        run: choco install ninja -y
        shell: pwsh

      - name: Install 7zip
        run: choco install 7zip -y
        shell: pwsh

      - name: Fetch libmpv SDK
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          $ghHeaders = @{
            "User-Agent" = "Bloom-CI"
            "Accept" = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
            "Authorization" = "Bearer $env:GITHUB_TOKEN"
          }
          Write-Host "Using github.token for authenticated GitHub API requests."

          $release = $null
          for ($attempt = 1; $attempt -le 3; $attempt++) {
            try {
              $release = Invoke-RestMethod -Uri "https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest" -Headers $ghHeaders
              break
            } catch {
              if ($attempt -eq 3) { throw }
              $sleepSec = 5 * $attempt
              Write-Warning "GitHub API request failed (attempt $attempt/3). Retrying in $sleepSec seconds..."
              Start-Sleep -Seconds $sleepSec
            }
          }

          $asset = $release.assets | Where-Object { $_.name -match '^mpv-dev-x86_64-.*\.(7z|zip)$' } | Select-Object -First 1
          if (-not $asset) {
            Write-Error "Could not find mpv-dev-x86_64 SDK asset in latest shinchiro/mpv-winbuild-cmake release."
            exit 1
          }

          $downloadPath = Join-Path $PWD $asset.name
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $downloadPath -Headers $ghHeaders

          $extractRoot = Join-Path $PWD "third_party\mpv"
          if (Test-Path $extractRoot) { Remove-Item -Recurse -Force $extractRoot }
          New-Item -ItemType Directory -Path $extractRoot | Out-Null

          if ($asset.name.ToLower().EndsWith(".zip")) {
            Expand-Archive -Path $downloadPath -DestinationPath $extractRoot -Force
          } else {
            & 7z x $downloadPath "-o$extractRoot" -y | Out-Null
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to extract $($asset.name) with 7z."
              exit 1
            }
          }

          $mpvRootCandidate = Get-ChildItem -Path $extractRoot -Directory -Recurse |
            Where-Object { Test-Path (Join-Path $_.FullName "include\mpv\client.h") } |
            Select-Object -First 1

          if ($mpvRootCandidate) {
            $mpvRoot = $mpvRootCandidate.FullName
          } elseif (Test-Path (Join-Path $extractRoot "include\mpv\client.h")) {
            $mpvRoot = $extractRoot
          } else {
            Write-Error "Extracted mpv-dev SDK does not contain include\\mpv\\client.h"
            exit 1
          }

          $importLib = Get-ChildItem -Path $mpvRoot -Recurse -File -ErrorAction SilentlyContinue |
            Where-Object { $_.Name -in @("libmpv-2.lib", "mpv-2.lib", "libmpv.lib", "mpv.lib") } |
            Select-Object -First 1

          if (-not $importLib) {
            $mpvDll = Get-ChildItem -Path $mpvRoot -Recurse -File -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -in @("libmpv-2.dll", "mpv-2.dll", "mpv.dll") } |
              Select-Object -First 1

            if (-not $mpvDll) {
              Write-Error "mpv-dev bundle has no import library and no runtime DLL to generate one from."
              exit 1
            }

            $libDir = Join-Path $mpvRoot "lib"
            if (-not (Test-Path $libDir)) {
              New-Item -ItemType Directory -Path $libDir | Out-Null
            }

            $exportsRaw = & dumpbin /exports $mpvDll.FullName
            if ($LASTEXITCODE -ne 0) {
              Write-Error "dumpbin failed while reading exports from $($mpvDll.FullName)"
              exit 1
            }

            $exportNames = New-Object System.Collections.Generic.List[string]
            foreach ($line in $exportsRaw) {
              if ($line -match "^\s+\d+\s+[0-9A-F]+\s+[0-9A-F]+\s+(\S+)$") {
                $name = $matches[1]
                if ($name -and $name -ne "[NONAME]") {
                  $exportNames.Add($name)
                }
              }
            }

            if ($exportNames.Count -eq 0) {
              Write-Error "No exports parsed from $($mpvDll.FullName); cannot generate import library."
              exit 1
            }

            $defPath = Join-Path $libDir "libmpv-2.def"
            $defContent = @("LIBRARY libmpv-2.dll", "EXPORTS") + ($exportNames | Sort-Object -Unique)
            Set-Content -Path $defPath -Value $defContent -Encoding ascii

            $outLib = Join-Path $libDir "libmpv-2.lib"
            & lib /def:$defPath /machine:x64 /out:$outLib
            if ($LASTEXITCODE -ne 0 -or -not (Test-Path $outLib)) {
              Write-Error "Failed to generate MSVC import library at $outLib"
              exit 1
            }

            Write-Host "Generated import library: $outLib"
          }

          "MPV_ROOT=$mpvRoot" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "Using MPV_ROOT=$mpvRoot"

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: .sccache
          key: ${{ runner.os }}-sccache-msvc2022-qt610-v2
          restore-keys: |
            ${{ runner.os }}-sccache-msvc2022-qt610-
            ${{ runner.os }}-sccache-

      - name: Setup sccache
        run: |
          $version = "v0.8.1"
          $url = "https://github.com/mozilla/sccache/releases/download/$version/sccache-$version-x86_64-pc-windows-msvc.zip"
          Invoke-WebRequest -Uri $url -OutFile sccache.zip
          Expand-Archive sccache.zip -DestinationPath sccache
          echo "$PWD\sccache\sccache-$version-x86_64-pc-windows-msvc" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Build
        env:
          SCCACHE_DIR: ${{ github.workspace }}/.sccache
          SCCACHE_CACHE_SIZE: "4G"
        shell: pwsh
        run: |
          sccache --start-server
          $installPrefix = [System.IO.Path]::GetFullPath((Join-Path $PWD "install-windows"))
          if (-Not (Test-Path build-windows)) {
            New-Item -ItemType Directory -Path build-windows
          }
          cd build-windows
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX="$installPrefix" -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          cmake --build .
          cmake --install . --config Release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          $cacheFile = Join-Path $PWD "CMakeCache.txt"
          if (Test-Path $cacheFile) {
            $hasMpvHeaders = Select-String -Path $cacheFile -Pattern "^BLOOM_MPV_INCLUDE_DIR:PATH=.*$" | Select-Object -First 1
            $hasMpvLib = Select-String -Path $cacheFile -Pattern "^BLOOM_MPV_LIBRARY:FILEPATH=.*$" | Select-Object -First 1
            $mpvMissing = (($hasMpvHeaders -and $hasMpvHeaders.Line -match "NOTFOUND") -or ($hasMpvLib -and $hasMpvLib.Line -match "NOTFOUND") -or (-not $hasMpvHeaders) -or (-not $hasMpvLib))
            if ($mpvMissing) {
              Write-Error "libmpv SDK not detected during configure (BLOOM_MPV_INCLUDE_DIR/BLOOM_MPV_LIBRARY). Windows build requires direct libmpv support."
              exit 1
            }
          }
          if (Test-Path "$installPrefix\bin\Bloom.exe") {
            Write-Host "Installed Bloom.exe at $installPrefix\bin\Bloom.exe"
          } else {
            Write-Warning "Bloom.exe not found at expected install path: $installPrefix\bin\Bloom.exe"
            Get-ChildItem -Path "$installPrefix" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          }
          sccache --show-stats
          sccache --stop-server

      - name: Package App
        shell: pwsh
        run: |
          ./scripts/package-windows.ps1 -InstallDir install-windows -OutputDir Bloom-Windows

      - name: Verify libmpv Runtime Present
        shell: pwsh
        run: |
          $libmpv = Get-ChildItem -Path Bloom-Windows -Filter "*mpv*.dll" -File -Recurse -ErrorAction SilentlyContinue
          if (-not $libmpv) {
            Write-Error "No libmpv runtime DLL found in Bloom-Windows package. Windows playback policy requires bundled libmpv."
            exit 1
          }
          Write-Host "Found libmpv runtime: $($libmpv[0].Name)"

      - name: Install NSIS
        run: |
          choco install nsis -y
        shell: pwsh

      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        shell: pwsh

      - name: Create ZIP Archive and Hash
        id: archive
        run: |
          Compress-Archive -Path Bloom-Windows/* -DestinationPath Bloom-Windows.zip -Force
          $zipHash = (Get-FileHash Bloom-Windows.zip -Algorithm SHA256).Hash
          echo "zip_hash=$zipHash" >> $env:GITHUB_OUTPUT
          echo "ZIP Hash: $zipHash"

          if (Test-Path "Bloom-Setup-0.1.0.exe") {
            $installerHash = (Get-FileHash Bloom-Setup-0.1.0.exe -Algorithm SHA256).Hash
            echo "installer_hash=$installerHash" >> $env:GITHUB_OUTPUT
            echo "Installer Hash: $installerHash"
          }
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: dev-latest
          name: Development Build
          body: |
            Latest development build from main branch.

            ## Portable ZIP
            SHA256: `${{ steps.archive.outputs.zip_hash }}`

            ## Installer
            SHA256: `${{ steps.archive.outputs.installer_hash }}`
          prerelease: true
          files: |
            Bloom-Windows.zip
            Bloom-Setup-0.1.0.exe
          fail_on_unmatched_files: true

      - name: Trigger Scoop Bucket Update
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $version = (Get-Date).ToString("yyyy.MM.dd.HHmm")
          $payload = @{
            event_type = "update-manifest"
            client_payload = @{
              hash = "${{ steps.archive.outputs.zip_hash }}"
              url = "https://github.com/crowquillx/Bloom/releases/download/dev-latest/Bloom-Windows.zip"
              version = $version
            }
          } | ConvertTo-Json -Compress
          
          curl.exe -X POST `
            -H "Accept: application/vnd.github+json" `
            -H "Authorization: Bearer ${{ secrets.SCOOP_REPO_TOKEN }}" `
            https://api.github.com/repos/crowquillx/scoop-bloom/dispatches `
            -d $payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Windows-Portable
          path: Bloom-Windows/

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('Bloom-Setup-0.1.0.exe') != ''
        with:
          name: Bloom-Windows-Installer
          path: Bloom-Setup-0.1.0.exe

  linux:
    name: Linux Build & Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libwayland-dev \
            libsecret-1-dev \
            libmpv-dev \
            libsqlite3-dev \
            libtiff-dev \
            libfuse2 \
            dpkg-dev \
            file

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.0"
          cache: true
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat"

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Install to staging directory
        run: |
          DESTDIR=${{ github.workspace }}/install-linux cmake --install build
          echo "=== Install tree ==="
          find ${{ github.workspace }}/install-linux -type f | head -50

      - name: Build AppImage
        env:
          INSTALL_DIR: ${{ github.workspace }}/install-linux/usr
          OUTPUT_DIR: ${{ github.workspace }}/artifacts
        run: |
          ./scripts/package-linux-appimage.sh \
            --install-dir "$INSTALL_DIR" \
            --output-dir "$OUTPUT_DIR"

      - name: Build .deb package
        env:
          INSTALL_DIR: ${{ github.workspace }}/install-linux/usr
          OUTPUT_DIR: ${{ github.workspace }}/artifacts
        run: |
          VERSION=$(date -u +%Y.%m.%d.%H%M)
          ./scripts/package-linux-deb.sh \
            --install-dir "$INSTALL_DIR" \
            --output-dir "$OUTPUT_DIR" \
            --version "$VERSION"

      - name: Create Linux tarball
        run: |
          cd ${{ github.workspace }}/install-linux
          tar -czf ${{ github.workspace }}/artifacts/Bloom-Linux.tar.gz .

      - name: Compute SHA256 hashes
        id: linux_hashes
        run: |
          cd ${{ github.workspace }}/artifacts
          echo "=== Linux Artifacts ==="
          ls -la

          APPIMAGE=$(ls Bloom-*.AppImage 2>/dev/null | head -1)
          DEB=$(ls bloom_*.deb 2>/dev/null | head -1)

          if [ -n "$APPIMAGE" ]; then
            APPIMAGE_HASH=$(sha256sum "$APPIMAGE" | cut -d' ' -f1)
            echo "appimage_hash=$APPIMAGE_HASH" >> $GITHUB_OUTPUT
            echo "appimage_name=$APPIMAGE" >> $GITHUB_OUTPUT
            echo "AppImage SHA256: $APPIMAGE_HASH"
          fi

          if [ -n "$DEB" ]; then
            DEB_HASH=$(sha256sum "$DEB" | cut -d' ' -f1)
            echo "deb_hash=$DEB_HASH" >> $GITHUB_OUTPUT
            echo "deb_name=$DEB" >> $GITHUB_OUTPUT
            echo ".deb SHA256: $DEB_HASH"
          fi

          TARBALL_HASH=$(sha256sum Bloom-Linux.tar.gz | cut -d' ' -f1)
          echo "tarball_hash=$TARBALL_HASH" >> $GITHUB_OUTPUT
          echo "Tarball SHA256: $TARBALL_HASH"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-AppImage
          path: artifacts/Bloom-*.AppImage
          if-no-files-found: warn

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-Deb
          path: artifacts/bloom_*.deb
          if-no-files-found: warn

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-Tarball
          path: artifacts/Bloom-Linux.tar.gz

      - name: Update dev-latest release with Linux artifacts
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: dev-latest
          name: Development Build
          prerelease: true
          files: |
            artifacts/Bloom-*.AppImage
            artifacts/bloom_*.deb
            artifacts/Bloom-Linux.tar.gz
          fail_on_unmatched_files: false
