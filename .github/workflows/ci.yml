name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ui:
              - 'src/ui/**'
              - 'src/viewmodels/**'
              - 'src/test/**'
              - 'tests/fixtures/**'
              - 'tests/VisualRegressionTest*'
              - 'docs/responsive.md'
              - '.github/workflows/ci.yml'

  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.0"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2022_64"
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat"
          cache: true
          setup-python: false

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Ninja
        run: choco install ninja -y
        shell: pwsh

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Setup sccache
        run: |
          $version = "v0.8.1"
          $url = "https://github.com/mozilla/sccache/releases/download/$version/sccache-$version-x86_64-pc-windows-msvc.zip"
          Invoke-WebRequest -Uri $url -OutFile sccache.zip
          Expand-Archive sccache.zip -DestinationPath sccache
          echo "$PWD\sccache\sccache-$version-x86_64-pc-windows-msvc" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Build
        env:
          SCCACHE_DIR: ~/.cache/sccache
          SCCACHE_CACHE_SIZE: "2G"
        shell: pwsh
        run: |
          sccache --start-server
          if (-Not (Test-Path build-windows)) {
            New-Item -ItemType Directory -Path build-windows
          }
          cd build-windows
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=../install-windows -DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
          cmake --build .
          cmake --install . --config Release
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
          sccache --show-stats
          sccache --stop-server

      - name: Package App
        shell: pwsh
        run: |
          ./scripts/package-windows.ps1 -InstallDir install-windows -OutputDir Bloom-Windows

      - name: Verify libmpv Runtime Present
        shell: pwsh
        run: |
          $libmpv = Get-ChildItem -Path Bloom-Windows -Filter "*mpv*.dll" -File -ErrorAction SilentlyContinue
          if (-not $libmpv) {
            Write-Error "No libmpv runtime DLL found in Bloom-Windows package. Windows playback policy requires bundled libmpv."
            exit 1
          }
          Write-Host "Found libmpv runtime: $($libmpv[0].Name)"

      - name: Install NSIS
        run: |
          choco install nsis -y
        shell: pwsh

      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
        shell: pwsh

      - name: Create ZIP Archive and Hash
        id: archive
        run: |
          Compress-Archive -Path Bloom-Windows/* -DestinationPath Bloom-Windows.zip -Force
          $zipHash = (Get-FileHash Bloom-Windows.zip -Algorithm SHA256).Hash
          echo "zip_hash=$zipHash" >> $env:GITHUB_OUTPUT
          echo "ZIP Hash: $zipHash"

          if (Test-Path "Bloom-Setup-0.1.0.exe") {
            $installerHash = (Get-FileHash Bloom-Setup-0.1.0.exe -Algorithm SHA256).Hash
            echo "installer_hash=$installerHash" >> $env:GITHUB_OUTPUT
            echo "Installer Hash: $installerHash"
          }
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: dev-latest
          name: Development Build
          body: |
            Latest development build from main branch.

            ## Portable ZIP
            SHA256: `${{ steps.archive.outputs.zip_hash }}`

            ## Installer
            SHA256: `${{ steps.archive.outputs.installer_hash }}`
          prerelease: true
          files: |
            Bloom-Windows.zip
            Bloom-Setup-0.1.0.exe
          fail_on_unmatched_files: true

      - name: Trigger Scoop Bucket Update
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $version = (Get-Date).ToString("yyyy.MM.dd.HHmm")
          $payload = @{
            event_type = "update-manifest"
            client_payload = @{
              hash = "${{ steps.archive.outputs.zip_hash }}"
              url = "https://github.com/crowquillx/Bloom/releases/download/dev-latest/Bloom-Windows.zip"
              version = $version
            }
          } | ConvertTo-Json -Compress
          
          curl.exe -X POST `
            -H "Accept: application/vnd.github+json" `
            -H "Authorization: Bearer ${{ secrets.SCOOP_REPO_TOKEN }}" `
            https://api.github.com/repos/crowquillx/scoop-bloom/dispatches `
            -d $payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Windows-Portable
          path: Bloom-Windows/

      - name: Upload Installer Artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('Bloom-Setup-0.1.0.exe') != ''
        with:
          name: Bloom-Windows-Installer
          path: Bloom-Setup-0.1.0.exe

  visual-regression:
    name: Visual Regression Tests (Linux)
    runs-on: ubuntu-latest
    needs: changes
    if: false # Temporarily sidelined; re-enable once visual test CI is stabilized.
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            xvfb \
            mesa-vulkan-drivers \
            libsecret-1-dev \
            libwayland-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.0"
          cache: true
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat"
      
      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON
      
      - name: Build
        run: cmake --build build --parallel --target VisualRegressionTest
      
      - name: Run visual regression tests
        run: |
          ./build/tests/VisualRegressionTest
        env:
          QT_QPA_PLATFORM: offscreen
          QT_QPA_OFFSCREEN_SURFACE_SIZE: 1920x1080
          
      - name: Upload diff images on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diffs
          path: |
            tests/diffs/
            tests/captures/
            build/tests/diffs/
            build/tests/captures/
          retention-days: 7
          
      - name: Upload golden screenshots
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: golden-screenshots
          path: |
            tests/golden/
            build/tests/golden/
          retention-days: 30
