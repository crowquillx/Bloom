name: Linux Packaging

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  linux:
    name: Linux Build & Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libwayland-dev \
            libsecret-1-dev \
            libmpv-dev \
            libsqlite3-dev \
            libfuse2 \
            dpkg-dev \
            file

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.0"
          cache: true
          modules: "qtmultimedia qtshadertools qtimageformats qt5compat qtwayland"

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DBUILD_TESTING=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Install to staging directory
        run: |
          DESTDIR=${{ github.workspace }}/install-linux cmake --install build
          echo "=== Install tree ==="
          find ${{ github.workspace }}/install-linux -type f | head -50

      # --- AppImage ---
      - name: Build AppImage
        env:
          INSTALL_DIR: ${{ github.workspace }}/install-linux/usr
          OUTPUT_DIR: ${{ github.workspace }}/artifacts
        run: |
          ./scripts/package-linux-appimage.sh \
            --install-dir "$INSTALL_DIR" \
            --output-dir "$OUTPUT_DIR"

      # --- .deb ---
      - name: Build .deb package
        env:
          INSTALL_DIR: ${{ github.workspace }}/install-linux/usr
          OUTPUT_DIR: ${{ github.workspace }}/artifacts
        run: |
          VERSION=$(date -u +%Y.%m.%d.%H%M)
          ./scripts/package-linux-deb.sh \
            --install-dir "$INSTALL_DIR" \
            --output-dir "$OUTPUT_DIR" \
            --version "$VERSION"

      # --- Tarball (for Arch/PKGBUILD users) ---
      - name: Create Linux tarball
        run: |
          cd ${{ github.workspace }}/install-linux
          tar -czf ${{ github.workspace }}/artifacts/Bloom-Linux.tar.gz .

      # --- Hashes ---
      - name: Compute SHA256 hashes
        id: hashes
        run: |
          cd ${{ github.workspace }}/artifacts
          echo "=== Linux Artifacts ==="
          ls -la

          APPIMAGE=$(ls Bloom-*.AppImage 2>/dev/null | head -1)
          DEB=$(ls bloom_*.deb 2>/dev/null | head -1)

          if [ -n "$APPIMAGE" ]; then
            APPIMAGE_HASH=$(sha256sum "$APPIMAGE" | cut -d' ' -f1)
            echo "appimage_hash=$APPIMAGE_HASH" >> $GITHUB_OUTPUT
            echo "appimage_name=$APPIMAGE" >> $GITHUB_OUTPUT
            echo "AppImage SHA256: $APPIMAGE_HASH"
          fi

          if [ -n "$DEB" ]; then
            DEB_HASH=$(sha256sum "$DEB" | cut -d' ' -f1)
            echo "deb_hash=$DEB_HASH" >> $GITHUB_OUTPUT
            echo "deb_name=$DEB" >> $GITHUB_OUTPUT
            echo ".deb SHA256: $DEB_HASH"
          fi

          TARBALL_HASH=$(sha256sum Bloom-Linux.tar.gz | cut -d' ' -f1)
          echo "tarball_hash=$TARBALL_HASH" >> $GITHUB_OUTPUT
          echo "Tarball SHA256: $TARBALL_HASH"

      # --- Upload CI Artifacts ---
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-AppImage
          path: artifacts/Bloom-*.AppImage
          if-no-files-found: warn

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-Deb
          path: artifacts/bloom_*.deb
          if-no-files-found: warn

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bloom-Linux-Tarball
          path: artifacts/Bloom-Linux.tar.gz

      # --- Attach to dev-latest release (main branch only) ---
      - name: Update dev-latest release with Linux artifacts
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          tag_name: dev-latest
          name: Development Build
          body: |
            Latest development build from main branch.

            ## Windows
            See Windows CI artifacts for ZIP and installer.

            ## Linux

            ### AppImage
            SHA256: `${{ steps.hashes.outputs.appimage_hash }}`

            ### .deb (Debian/Ubuntu)
            SHA256: `${{ steps.hashes.outputs.deb_hash }}`

            ### Tarball (Arch Linux / generic)
            SHA256: `${{ steps.hashes.outputs.tarball_hash }}`
          prerelease: true
          files: |
            artifacts/Bloom-*.AppImage
            artifacts/bloom_*.deb
            artifacts/Bloom-Linux.tar.gz
          fail_on_unmatched_files: false
